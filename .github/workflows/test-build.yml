name: æµ‹è¯•æ„å»º
permissions:
  contents: read

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - "LICENSE"
      - ".gitignore"
      - ".editorconfig"
      - "images/**"
      - "screenshots/**"
      - ".vscode/**"
  pull_request:
    branches: [main]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - "LICENSE"
      - ".gitignore"
      - ".editorconfig"
      - "images/**"
      - "screenshots/**"
      - ".vscode/**"
  workflow_dispatch:

jobs:
  test-build:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v6

      - name: è®¾ç½® Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "18"

      - name: éªŒè¯ manifest æ–‡ä»¶
        run: |
          echo "éªŒè¯ Chrome manifest..."
          node -e "
            const manifest = JSON.parse(require('fs').readFileSync('manifest.json', 'utf8'));
            console.log('Chrome manifest ç‰ˆæœ¬:', manifest.version);
            console.log('Manifest ç‰ˆæœ¬:', manifest.manifest_version);
            if (manifest.manifest_version !== 3) {
              throw new Error('Chrome manifest åº”è¯¥ä½¿ç”¨ Manifest V3');
            }
          "

          echo "éªŒè¯ Firefox manifest..."
          node -e "
            const manifest = JSON.parse(require('fs').readFileSync('manifest-firefox.json', 'utf8'));
            console.log('Firefox manifest ç‰ˆæœ¬:', manifest.version);
            console.log('Manifest ç‰ˆæœ¬:', manifest.manifest_version);
            if (manifest.manifest_version !== 2) {
              throw new Error('Firefox manifest åº”è¯¥ä½¿ç”¨ Manifest V2');
            }
          "

      - name: æ£€æŸ¥å¿…éœ€æ–‡ä»¶
        run: |
          echo "æ£€æŸ¥å¿…éœ€æ–‡ä»¶æ˜¯å¦å­˜åœ¨..."

          required_files=(
            "manifest.json"
            "manifest-firefox.json"
            "src/background/index.js"
            "src/content/index.js"
            "src/popup/popup.js"
            "src/popup/index.html"
            "src/shared/compat/webext-compat.js"
            "src/shared/compat/firefox-compat.js"
            "src/shared/platform-detector.js"
            "src/shared/platforms.js"
            "build.py"
            "dev.py"
          )

          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file"
            else
              echo "âŒ $file ç¼ºå¤±"
              exit 1
            fi
          done

      - name: è¿è¡ŒåŸºç¡€æµ‹è¯•
        run: |
          echo "è¿è¡ŒåŸºç¡€æµ‹è¯•..."
          python dev.py test

      - name: è¿è¡Œä»£ç æ£€æŸ¥
        run: |
          echo "è¿è¡Œä»£ç æ£€æŸ¥..."
          python dev.py lint

      - name: æµ‹è¯• Chrome æ„å»º
        run: |
          echo "æµ‹è¯• Chrome æ„å»º..."
          python build.py --platform chrome

          # éªŒè¯æ„å»ºç»“æœ
          if [ -d "build/chrome" ]; then
            echo "âœ… Chrome æ„å»ºç›®å½•å·²åˆ›å»º"
            ls -la build/chrome/
          else
            echo "âŒ Chrome æ„å»ºå¤±è´¥"
            exit 1
          fi

      - name: æµ‹è¯• Firefox æ„å»º
        run: |
          echo "æµ‹è¯• Firefox æ„å»º..."
          python build.py --platform firefox

          # éªŒè¯æ„å»ºç»“æœ
          if [ -d "build/firefox" ]; then
            echo "âœ… Firefox æ„å»ºç›®å½•å·²åˆ›å»º"
            ls -la build/firefox/
          else
            echo "âŒ Firefox æ„å»ºå¤±è´¥"
            exit 1
          fi

      - name: æµ‹è¯•æ‰©å±•åŒ…ç”Ÿæˆ
        run: |
          echo "æµ‹è¯•æ‰©å±•åŒ…ç”Ÿæˆ..."
          python build.py --platform all --package

          # éªŒè¯æ‰©å±•åŒ…
          if [ -d "packages" ]; then
            echo "âœ… æ‰©å±•åŒ…ç›®å½•å·²åˆ›å»º"
            ls -la packages/
            
            # æ£€æŸ¥æ˜¯å¦æœ‰ Chrome å’Œ Firefox åŒ…
            if [ -f packages/xget-now-chrome-v*.zip ]; then
              echo "âœ… Chrome æ‰©å±•åŒ…å·²ç”Ÿæˆ"
            else
              echo "âŒ Chrome æ‰©å±•åŒ…ç”Ÿæˆå¤±è´¥"
            fi
            
            if [ -f packages/xget-now-firefox-v*.zip ]; then
              echo "âœ… Firefox æ‰©å±•åŒ…å·²ç”Ÿæˆ"
            else
              echo "âŒ Firefox æ‰©å±•åŒ…ç”Ÿæˆå¤±è´¥"
            fi
          else
            echo "âŒ æ‰©å±•åŒ…ç”Ÿæˆå¤±è´¥"
            exit 1
          fi

      - name: éªŒè¯æ„å»ºçš„ manifest æ–‡ä»¶
        run: |
          echo "éªŒè¯æ„å»ºçš„ manifest æ–‡ä»¶..."

          # æ£€æŸ¥ Chrome æ„å»ºçš„ manifest
          echo "æ£€æŸ¥ Chrome manifest..."
          node -e "
            const manifest = JSON.parse(require('fs').readFileSync('build/chrome/manifest.json', 'utf8'));
            console.log('Chrome æ„å»ºç‰ˆæœ¬:', manifest.version);
            if (manifest.manifest_version !== 3) {
              throw new Error('Chrome æ„å»ºåº”è¯¥ä½¿ç”¨ Manifest V3');
            }
            if (!manifest.action) {
              throw new Error('Chrome æ„å»ºåº”è¯¥æœ‰ action å­—æ®µ');
            }
          "

          # æ£€æŸ¥ Firefox æ„å»ºçš„ manifest
          echo "æ£€æŸ¥ Firefox manifest..."
          node -e "
            const manifest = JSON.parse(require('fs').readFileSync('build/firefox/manifest.json', 'utf8'));
            console.log('Firefox æ„å»ºç‰ˆæœ¬:', manifest.version);
            if (manifest.manifest_version !== 2) {
              throw new Error('Firefox æ„å»ºåº”è¯¥ä½¿ç”¨ Manifest V2');
            }
            if (!manifest.browser_action) {
              throw new Error('Firefox æ„å»ºåº”è¯¥æœ‰ browser_action å­—æ®µ');
            }
            if (!manifest.applications && !manifest.browser_specific_settings) {
              throw new Error('Firefox æ„å»ºåº”è¯¥æœ‰ applications æˆ– browser_specific_settings å­—æ®µ');
            }
          "

      - name: ä¸Šä¼ æ„å»ºç»“æœ
        uses: actions/upload-artifact@v5
        with:
          name: extension-builds-${{ github.sha }}
          path: |
            build/
            packages/
          retention-days: 7

      - name: æµ‹è¯•æ€»ç»“
        run: |
          echo ""
          echo "ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼"
          echo "================================"
          echo "âœ… Manifest æ–‡ä»¶éªŒè¯"
          echo "âœ… å¿…éœ€æ–‡ä»¶æ£€æŸ¥"
          echo "âœ… åŸºç¡€æµ‹è¯•"
          echo "âœ… ä»£ç æ£€æŸ¥"
          echo "âœ… Chrome æ„å»º"
          echo "âœ… Firefox æ„å»º"
          echo "âœ… æ‰©å±•åŒ…ç”Ÿæˆ"
          echo "âœ… æ„å»ºç»“æœéªŒè¯"
          echo "================================"
          echo "ğŸš€ å‡†å¤‡å‘å¸ƒï¼"
