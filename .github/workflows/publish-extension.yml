name: å‘å¸ƒæ‰©å±•åˆ°å¤šä¸ªåº”ç”¨å•†åº—

# å·¥ä½œæµè§¦å‘æ¡ä»¶ï¼šæ‰‹åŠ¨è§¦å‘ï¼Œå…è®¸æŒ‡å®šç‰ˆæœ¬å·
on:
  workflow_dispatch:
    inputs:
      version:
        description: "ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0)"
        required: true
        type: string

# å·¥ä½œæµæƒé™è®¾ç½®
permissions:
  contents: write # åˆ›å»º GitHub Release éœ€è¦
  packages: write # å‘å¸ƒåŒ…éœ€è¦

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      # ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºæºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v6

      # ç¬¬äºŒæ­¥ï¼šè®¾ç½® Python ç¯å¢ƒç”¨äºæ„å»ºè„šæœ¬
      - name: è®¾ç½® Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      # ç¬¬ä¸‰æ­¥ï¼šè®¾ç½® Node.js ç¯å¢ƒç”¨äº JSON éªŒè¯
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "18"

      # ç¬¬å››æ­¥ï¼šéªŒè¯ manifest æ–‡ä»¶æ ¼å¼
      - name: éªŒè¯ manifest æ–‡ä»¶
        run: |
          # éªŒè¯ Chrome manifest.json æ˜¯å¦ä¸ºæœ‰æ•ˆçš„ JSON
          node -e "JSON.parse(require('fs').readFileSync('manifest.json', 'utf8'))"
          echo "âœ… Chrome manifest.json æ ¼å¼æœ‰æ•ˆ"

          # éªŒè¯ Firefox manifest æ˜¯å¦ä¸ºæœ‰æ•ˆçš„ JSON
          node -e "JSON.parse(require('fs').readFileSync('manifest-firefox.json', 'utf8'))"
          echo "âœ… Firefox manifest.json æ ¼å¼æœ‰æ•ˆ"

      # ç¬¬äº”æ­¥ï¼šè®¾ç½®ç‰ˆæœ¬å·
      - name: ä»è¾“å…¥è®¾ç½®ç‰ˆæœ¬
        id: version
        run: |
          # ä»å·¥ä½œæµè¾“å…¥è·å–ç‰ˆæœ¬å·
          VERSION="${{ inputs.version }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "æ‰‹åŠ¨è®¾ç½®ç‰ˆæœ¬: $VERSION"

      # ç¬¬å…­æ­¥ï¼šæ›´æ–°æ‰€æœ‰é…ç½®æ–‡ä»¶ä¸­çš„ç‰ˆæœ¬å·
      - name: æ›´æ–° manifest ç‰ˆæœ¬
        run: |
          # æ›´æ–° Chrome manifest.json ä¸­çš„ç‰ˆæœ¬
          node -e "
            const fs = require('fs');
            const manifest = JSON.parse(fs.readFileSync('manifest.json', 'utf8'));
            manifest.version = '${{ steps.version.outputs.version }}';
            fs.writeFileSync('manifest.json', JSON.stringify(manifest, null, 2));
            console.log('å·²æ›´æ–° Chrome manifest.json ç‰ˆæœ¬ä¸º:', manifest.version);
          "

          # æ›´æ–° Firefox manifest.json ä¸­çš„ç‰ˆæœ¬
          node -e "
            const fs = require('fs');
            const manifest = JSON.parse(fs.readFileSync('manifest-firefox.json', 'utf8'));
            manifest.version = '${{ steps.version.outputs.version }}';
            fs.writeFileSync('manifest-firefox.json', JSON.stringify(manifest, null, 2));
            console.log('å·²æ›´æ–° Firefox manifest.json ç‰ˆæœ¬ä¸º:', manifest.version);
          "

      # ç¬¬ä¸ƒæ­¥ï¼šåŒæ­¥æ›´æ–° package.json ç‰ˆæœ¬
      - name: æ›´æ–° package.json ç‰ˆæœ¬
        run: |
          # æ›´æ–° package.json ä¸­çš„ç‰ˆæœ¬ä»¥ä¿æŒä¸€è‡´æ€§
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.version = '${{ steps.version.outputs.version }}';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
            console.log('å·²æ›´æ–° package.json ç‰ˆæœ¬ä¸º:', pkg.version);
          "

      # ç¬¬å…«æ­¥ï¼šæäº¤ç‰ˆæœ¬æ›´æ”¹å¹¶åˆ›å»º Git æ ‡ç­¾
      - name: æäº¤å¹¶æ¨é€ç‰ˆæœ¬æ›´æ–°
        run: |
          # é…ç½® Git ç”¨æˆ·ä¿¡æ¯ç”¨äºè‡ªåŠ¨æäº¤
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # æ·»åŠ æ›´æ–°çš„æ–‡ä»¶
          git add manifest.json manifest-firefox.json package.json

          # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æäº¤çš„æ›´æ”¹
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰ç‰ˆæœ¬æ›´æ”¹éœ€è¦æäº¤"
          else
            # æäº¤ç‰ˆæœ¬æ›´æ–°
            git commit -m "chore: æ›´æ–°ç‰ˆæœ¬åˆ° ${{ steps.version.outputs.version }} [skip ci]"
            
            # ä¸ºæ­¤ç‰ˆæœ¬åˆ›å»ºå¹¶æ¨é€æ–°æ ‡ç­¾
            git tag "v${{ steps.version.outputs.version }}"
            
            # æ¨é€åˆ°ä¸»åˆ†æ”¯å¹¶åŒ…å«æ ‡ç­¾
            git push origin HEAD:main
            git push origin "v${{ steps.version.outputs.version }}"
            
            echo "âœ… ç‰ˆæœ¬æ›´æ–°å·²æäº¤å¹¶æ¨é€åˆ°ä¸»åˆ†æ”¯ï¼ŒåŒ…å«æ ‡ç­¾"
          fi

      - name: æ„å»ºæ‰©å±•åŒ…
        run: |
          echo "ğŸ—ï¸ å¼€å§‹æ„å»ºæ‰©å±•åŒ…..."

          # è¿è¡Œæ„å»ºè„šæœ¬æ„å»ºæ‰€æœ‰å¹³å°
          python build.py --platform all --package

          echo "ğŸ“¦ æ‰©å±•åŒ…æ„å»ºå®Œæˆ"
          ls -la packages/ || echo "packages ç›®å½•ä¸å­˜åœ¨"

      - name: è¿è¡Œæµ‹è¯•
        run: |
          echo "ğŸ§ª è¿è¡ŒåŸºç¡€æµ‹è¯•..."
          python dev.py test

          echo "ğŸ” è¿è¡Œä»£ç æ£€æŸ¥..."
          python dev.py lint

      - name: å‘å¸ƒåˆ° Chrome åº”ç”¨å•†åº—
        continue-on-error: true
        id: chrome-publish
        uses: mnao305/chrome-extension-upload@v5.0.0
        with:
          file-path: packages/Xget-Now_${{ steps.version.outputs.version }}.chromium.zip
          extension-id: ${{ secrets.CHROME_EXTENSION_ID }}
          client-id: ${{ secrets.CHROME_CLIENT_ID }}
          client-secret: ${{ secrets.CHROME_CLIENT_SECRET }}
          refresh-token: ${{ secrets.CHROME_REFRESH_TOKEN }}
          publish: true

      - name: å‘å¸ƒåˆ° Edge åŠ è½½é¡¹
        continue-on-error: true
        id: edge-publish
        uses: wdzeng/edge-addon@v2
        with:
          product-id: ${{ secrets.EDGE_PRODUCT_ID }}
          zip-path: packages/Xget-Now_${{ steps.version.outputs.version }}.chromium.zip
          api-key: ${{ secrets.EDGE_API_KEY }}
          client-id: ${{ secrets.EDGE_CLIENT_ID }}
          notes-for-certification: "è‡ªåŠ¨å‘å¸ƒ v${{ steps.version.outputs.version }} - ${{ github.sha }}"

      - name: å‘å¸ƒåˆ° Firefox é™„åŠ ç»„ä»¶
        continue-on-error: true
        id: firefox-publish
        uses: browser-actions/release-firefox-addon@latest
        with:
          addon-id: ${{ secrets.FIREFOX_ADDON_ID }}
          addon-path: packages/Xget-Now_${{ steps.version.outputs.version }}.firefox.xpi
          auth-api-issuer: ${{ secrets.FIREFOX_AUTH_API_ISSUER }}
          auth-api-secret: ${{ secrets.FIREFOX_AUTH_API_SECRET }}
          approval-note: |
            è¿™æ˜¯ä¸€ä¸ªä¸‹è½½åŠ é€Ÿå™¨æ‰©å±•ï¼Œæ”¯æŒå¤šä¸ªå¹³å°çš„æ–‡ä»¶ä¸‹è½½åŠ é€Ÿã€‚
            æºä»£ç ä½äº GitHub: https://github.com/xixu-me/Xget-Now
            æ„å»ºè¯´æ˜ï¼šç›´æ¥ä»æºä»£ç æ‰“åŒ…ï¼Œæ— éœ€ç¼–è¯‘æˆ–è½¬è¯‘ã€‚

      - name: åˆ›å»º GitHub å‘å¸ƒ
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Xget Now ${{ steps.version.outputs.version }}
          files: |
            packages/Xget-Now_${{ steps.version.outputs.version }}.chromium.zip
            packages/Xget-Now_${{ steps.version.outputs.version }}.firefox.xpi
          generate_release_notes: true
          body: |
            ## ğŸ“¦ æ‰©å±•åŒ…ä¸‹è½½

            ### Chromium
            - **æ–‡ä»¶**: `Xget-Now_${{ steps.version.outputs.version }}.chromium.zip`
            - **æ”¯æŒ**: Chromeã€Edge ç­‰åŸºäº Chromium çš„æµè§ˆå™¨
            - **Manifest**: v3

            ### Firefox
            - **æ–‡ä»¶**: `Xget-Now_${{ steps.version.outputs.version }}.firefox.xpi`
            - **æ”¯æŒ**: Firefox æˆ–å…¶ä»–åŸºäº Firefox çš„æµè§ˆå™¨
            - **Manifest**: v2

            ## ğŸš€ å®‰è£…æ–¹æ³•

            è¯¦ç»†çš„å®‰è£…è¯´æ˜è¯·å‚è€ƒï¼š[æ‰‹åŠ¨å®‰è£…æŒ‡å—](https://github.com/xixu-me/Xget-Now?tab=readme-ov-file#%E6%89%8B%E5%8A%A8%E5%AE%89%E8%A3%85)

            ## ğŸ“ æ›´æ–°æ—¥å¿—

            è¯¦ç»†çš„æ›´æ”¹å†…å®¹è¯·æŸ¥çœ‹ä¸‹æ–¹çš„è‡ªåŠ¨ç”Ÿæˆçš„å‘å¸ƒè¯´æ˜ã€‚

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: æ£€æŸ¥å‘å¸ƒç»“æœ
        run: |
          echo "ğŸ“Š å‘å¸ƒç»“æœæ‘˜è¦:"
          echo "================================"
          echo "ğŸ“¦ ç‰ˆæœ¬: ${{ steps.version.outputs.version }}"
          echo ""

          if [ "${{ steps.chrome-publish.outcome }}" = "success" ]; then
            echo "âœ… Chrome åº”ç”¨å•†åº—: å‘å¸ƒæˆåŠŸ"
          elif [ "${{ steps.chrome-publish.outcome }}" = "failure" ]; then
            echo "âŒ Chrome åº”ç”¨å•†åº—: å‘å¸ƒå¤±è´¥"
          else
            echo "âš ï¸ Chrome åº”ç”¨å•†åº—: å·²è·³è¿‡ï¼ˆç¼ºå°‘å¯†é’¥æˆ–å…¶ä»–åŸå› ï¼‰"
          fi

          if [ "${{ steps.edge-publish.outcome }}" = "success" ]; then
            echo "âœ… Edge åŠ è½½é¡¹: å‘å¸ƒæˆåŠŸ"
          elif [ "${{ steps.edge-publish.outcome }}" = "failure" ]; then
            echo "âŒ Edge åŠ è½½é¡¹: å‘å¸ƒå¤±è´¥"
          else
            echo "âš ï¸ Edge åŠ è½½é¡¹: å·²è·³è¿‡ï¼ˆç¼ºå°‘å¯†é’¥æˆ–å…¶ä»–åŸå› ï¼‰"
          fi

          if [ "${{ steps.firefox-publish.outcome }}" = "success" ]; then
            echo "âœ… Firefox é™„åŠ ç»„ä»¶: å‘å¸ƒæˆåŠŸ"
          elif [ "${{ steps.firefox-publish.outcome }}" = "failure" ]; then
            echo "âŒ Firefox é™„åŠ ç»„ä»¶: å‘å¸ƒå¤±è´¥"
          else
            echo "âš ï¸ Firefox é™„åŠ ç»„ä»¶: å·²è·³è¿‡ï¼ˆç¼ºå°‘å¯†é’¥æˆ–å…¶ä»–åŸå› ï¼‰"
          fi

          echo ""
          echo "âœ… GitHub å‘å¸ƒ: å·²åˆ›å»ºåŒ…å«æ‰€æœ‰æ‰©å±•æ–‡ä»¶"
          echo "================================"

      - name: é€šçŸ¥æˆåŠŸ
        run: |
          echo ""
          echo "ğŸ‰ æˆåŠŸå‘å¸ƒ Xget Now ${{ steps.version.outputs.version }}!"
          echo "================================"
          echo "ğŸ”— Chrome åº”ç”¨å•†åº—: https://chrome.google.com/webstore/detail/${{ secrets.CHROME_EXTENSION_ID }}"
          echo "ğŸ”— Edge åŠ è½½é¡¹: æŸ¥çœ‹å‘å¸ƒé¡µé¢è·å–æœ€æ–°ä¿¡æ¯"
          echo "ğŸ¦Š Firefox é™„åŠ ç»„ä»¶: æŸ¥çœ‹ Mozilla Add-ons è·å–æœ€æ–°ä¿¡æ¯"
          echo "ğŸ“¦ GitHub å‘å¸ƒ: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }}"
          echo "ğŸ“– å®‰è£…æŒ‡å—: https://github.com/${{ github.repository }}#installation"
          echo ""
          echo "ğŸ“ å‘å¸ƒçš„æ–‡ä»¶:"
          echo "  - Xget-Now_${{ steps.version.outputs.version }}.chromium.zip (Chromium)"
          echo "  - Xget-Now_${{ steps.version.outputs.version }}.firefox.xpi (Firefox)"
          echo "================================"
